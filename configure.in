AC_INIT()

AC_CONFIG_HEADER(common/c_config.h)
AC_CONFIG_AUX_DIR(script)

if test -d ${top_srcdir-$srcdir}/mkf -a -d ${top_srcdir-$srcdir}/kiklib ; then
	mkdir -p mkf kiklib
	ln -sf ../kiklib ${top_srcdir-$srcdir}/mkf
	ln -sf ../kiklib mkf
	SUBDIRS="kiklib mkf"
	MKF_LIBS='${top_builddir}/mkf/lib/libmkf.la'
	MKF_CFLAGS='-I${top_builddir}/mkf/include'
	KIK_LIBS='${top_builddir}/kiklib/src/libkik.la'
	KIK_CFLAGS='-I${top_builddir}/kiklib/include'
else
	MKF_LIBS="-lmkf"
	KIK_LIBS="-lkik"
fi
AC_SUBST(MKF_LIBS)
AC_SUBST(MKF_CFLAGS)
AC_SUBST(KIK_LIBS)
AC_SUBST(KIK_CFLAGS)

AC_PROG_CC
AC_PROG_INSTALL

AC_ARG_WITH(libtool,
	[  --with-libtool          libtool path[without]],
	libtool=$with_libtool)
if test "${libtool}" != "" ; then
	LIBTOOL=${libtool}
else
	AM_PROG_LIBTOOL
	LIBTOOL='${top_builddir}/libtool'
fi
AC_SUBST(LIBTOOL)

AC_CHECK_LIB(socket,connect,SOCK_LIBS=-lsocket)
AC_SUBST(SOCK_LIBS)

AC_PATH_XTRA

# Li18nux Xlib-I18N defines X_HAVE_UTF8_STRING but has no Xutf8LookupString.
ldflags="$LDFLAGS" cflags="$CFLAGS"
LDFLAGS="$LDFLAGS $X_PRE_LIBS $X_LIBS $X_EXTRA_LIBS" CFLAGS="$X_CFLAGS $CFLAGS"
AC_CHECK_LIB(X11,Xutf8LookupString,XUTF8_CFLAGS="-DHAVE_XUTF8_LOOKUP_STRING")
LDFLAGS="$ldflags" CFLAGS="$cflags"
AC_SUBST(XUTF8_CFLAGS)

AC_ARG_ENABLE(debug,
	[  --enable-debug          debug[disabled]],
	debug=$enable_debug)
if test "$debug" = "yes" ; then
	DEB_CFLAGS="-DDEBUG -DKIK_DEBUG"
fi
AC_SUBST(DEB_CFLAGS)
AC_SUBST(OPT_CFLAGS)

AC_ARG_ENABLE(fribidi,
	[  --enable-fribidi        bidi[disabled]],
	fribidi=$enable_fribidi)
if test "$fribidi" = "yes" ; then
	AC_CHECK_PROG(fribidi_config,fribidi-config,yes)
	if test "$fribidi_config" = "yes" ; then
		FRIBIDI_CFLAGS="`fribidi-config --cflags` -DUSE_FRIBIDI"
		FRIBIDI_LIBS="`fribidi-config --libs`"
	fi
fi
AC_SUBST(FRIBIDI_CFLAGS)
AC_SUBST(FRIBIDI_LIBS)

# default value
IMAGELIB_NAME=none
AC_ARG_WITH(imagelib,
	[  --with-imagelib[=ARG]   image library [imlib, gdk-pixbuf2, gdk-pixbuf1]],
	imagelib=$with_imagelib)
case ${imagelib} in
imlib)
	AC_CHECK_PROG(imlib_config,imlib-config,yes)
	if test "$imlib_config" = "yes" ; then
		IMAGELIB_CFLAGS="`imlib-config --cflags` -DUSE_IMLIB"
		IMAGELIB_LIBS="`imlib-config --libs`"
		IMAGELIB_NAME=imlib
	fi
	;;
gdk-pixbuf2)
	AC_CHECK_PROG(pkg_config,pkg-config,yes)
	if test "$pkg_config" = "yes" ; then
		IMAGELIB_CFLAGS="`pkg-config --cflags gdk-pixbuf-2.0` -DUSE_GDK_PIXBUF"
		IMAGELIB_LIBS="`pkg-config --libs gdk-pixbuf-2.0`"
		IMAGELIB_NAME=gdk
	fi
	;;
gdk-pixbuf1)
	AC_CHECK_PROG(pkg_config,gdk-pixbuf-config,yes)
	if test "$pkg_config" = "yes" ; then
		IMAGELIB_CFLAGS="`gdk-pixbuf-config --cflags` -DUSE_GDK_PIXBUF -DOLD_GDK_PIXBUF"
		IMAGELIB_LIBS="`gdk-pixbuf-config --libs`"
		IMAGELIB_NAME=gdk
	fi
	;;
*)
	if test "${imagelib}" != "" ; then
		echo ""
		echo "${imagelib} library is NOT supported."
		echo ""
		exit 1
	fi
	;;
esac
AC_SUBST(IMAGELIB_CFLAGS)
AC_SUBST(IMAGELIB_LIBS)
AC_SUBST(IMAGELIB_NAME)

AC_ARG_ENABLE(anti_alias,
	[  --enable-anti-alias     anti alias[disabled]],
	anti_alias=$enable_anti_alias)
if test "$anti_alias" = "yes" ; then
	AC_CHECK_PROG(pkg_config,pkg-config,yes)
	if test "$pkg_config" = "yes" ; then
		if `pkg-config --exists xft` ; then
			AA_CFLAGS="`pkg-config --cflags xft` -DANTI_ALIAS"
			AA_LIBS="`pkg-config --libs xft`"
		else
			AA_CFLAGS="-DANTI_ALIAS"
			AA_LIBS="-lXft"
		fi
	else
		AA_CFLAGS="-DANTI_ALIAS"
		AA_LIBS="-lXft"
	fi
fi
AC_SUBST(AA_CFLAGS)
AC_SUBST(AA_LIBS)
AC_SUBST(PROG)

AC_ARG_ENABLE(ind,
	[  --enable-ind            libind[disabled]],
	ind=$enable_ind)
if test "$ind" = "yes" ; then
	AC_CHECK_LIB(ind,indian_init,
		[
		IND_CFLAGS="-DUSE_IND"
		IND_LIBS="-lind"
		])
fi
AC_SUBST(IND_LIBS)
AC_SUBST(IND_CFLAGS)

AC_ARG_ENABLE(utmp,
	[  --enable-utmp           utmp[disabled]],
	utmp=$enable_utmp)
if test "$utmp" = "yes" ; then
	UTMP_CFLAGS="-DUSE_UTMP"
	has_utmp=`grep utmp /etc/group 2>/dev/null`
	if test "$has_utmp" ; then
		INSTALL_OPT="-m 2755 -g utmp"
	else
		INSTALL_OPT="-m 4755 -o root"
	fi
else
	INSTALL_OPT="-m 755"
fi
AC_SUBST(UTMP_CFLAGS)
AC_SUBST(INSTALL_OPT)

AC_CHECK_PROG(gtk_config,gtk-config,yes)
if test "$gtk_config" = "yes" ; then
	AC_PATH_PROG(GTK_CONFIG,gtk-config,/usr/local/bin/gtk-config,$PATH)
else
	# for Daichi Goto-san:)
	AC_CHECK_PROG(gtk_config,gtk12-config,yes)
	if test "$gtk_config" = "yes" ; then
		AC_PATH_PROG(GTK_CONFIG,gtk12-config,/usr/X11R6/bin/gtk12-config,$PATH)
	fi
fi
AC_SUBST(GTK_CONFIG)

tools="mlclient,mlconfig,mlterm-menu"
AC_ARG_WITH(tools,
	[  --with-tools[=ARG]      external tools [mlclient,mlconfig,mlterm-menu]],
	[
	# If given --without-tools or --with-tools with no args.
	if test "${with_tools}" = "no" ; then
		tools=""
	elif test "${with_tools}" != "yes" ; then
		tools=${with_tools}
	fi
	])
tools=`echo ${tools} | sed 's/,/ /g'`
for tool in ${tools} ; do
case ${tool} in
mlconfig)
	if test "${gtk_config}" = "yes" ; then
		MAKE_DIRS="tool/mlconfig ${MAKE_DIRS}"
		OUTPUT_FILES="tool/mlconfig/Makefile tool/mlconfig/po/Makefile.in ${OUTPUT_FILES}"
	fi
	;;
mlterm-menu)
	if test "${gtk_config}" = "yes" ; then
		MAKE_DIRS="contrib/tool/mlterm-menu ${MAKE_DIRS}"
		OUTPUT_FILES="contrib/tool/mlterm-menu/Makefile ${OUTPUT_FILES}"
	fi
	;;
mlclient)
	MAKE_DIRS="tool/mlclient ${MAKE_DIRS}"
	OUTPUT_FILES="tool/mlclient/Makefile ${OUTPUT_FILES}"
	;;
w3mmlconfig)
	MAKE_DIRS="tool/w3mmlconfig ${MAKE_DIRS}"
	;;
mlcc)
	MAKE_DIRS="contrib/tool/mlcc ${MAKE_DIRS}"
	;;
mlconf_curses)
	MAKE_DIRS="contrib/tool/mlconf_curses ${MAKE_DIRS}"
	;;
*)
	echo "${tool} is unknown tool."
	;;
esac
done

scrollbars="sample,extra"
AC_ARG_WITH(scrollbars,
	[  --with-scrollbars[=ARG] scrollbar plugins [sample,extra]],
	[
	# If given --without-scrollbars or --with-scrollbars with no args.
	if test "${with_scrollbars}" = "no" ; then
		scrollbars=""
	elif test "${with_scrollbars}" != "yes" ; then
		scrollbars=${with_scrollbars}
	fi
	])
scrollbars=`echo ${scrollbars} | sed 's/,/ /g'`
for scrollbar in ${scrollbars} ; do
case ${scrollbar} in
sample)
	MAKE_DIRS="scrollbar/sample ${MAKE_DIRS}"
	OUTPUT_FILES="scrollbar/sample/Makefile ${OUTPUT_FILES}"
	;;
extra)
	MAKE_DIRS="contrib/scrollbar/extra ${MAKE_DIRS}"
	OUTPUT_FILES="contrib/scrollbar/extra/Makefile ${OUTPUT_FILES}"
	;;
*)
	echo "${scrollbar} is unknown scrollbar."
	;;
esac
done

MAKE_DIRS="mlterm xwindow man etc ${MAKE_DIRS}"
OUTPUT_FILES="Makefile mlterm/Makefile xwindow/Makefile man/Makefile etc/Makefile ${OUTPUT_FILES}"

AC_SUBST(MAKE_DIRS)
AC_SUBST(OUTPUT_FILES)

# gettext
AM_INIT_AUTOMAKE(mlterm,2.6.2)
AM_GNU_GETTEXT([external])

# XXX(maybe not portable)
if test "${USE_NLS}" = "yes" ; then
	AC_CHECK_LIB(intl,gettext,
		[
		INTL_LIBS="-lintl"
		])
fi
AC_SUBST(INTL_LIBS)

# CVS revision
CVS_REVISION=`tail -n 1 ${top_srcdir-$srcdir}/ChangeLog | sed -n 's/^.Id: .* \(.*\) .* .* .* Exp .$/\1/p`
AC_SUBST(CVS_REVISION)
OUTPUT_FILES="xwindow/version.h ${OUTPUT_FILES}"

if test "${SUBDIRS}" != "" ; then
	AC_CONFIG_SUBDIRS(${SUBDIRS})
fi

if test "${MAKE_DIRS}" != "" ; then
	mkdir -p ${MAKE_DIRS}
fi

AC_OUTPUT(${OUTPUT_FILES})
